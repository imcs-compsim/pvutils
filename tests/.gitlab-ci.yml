#------------------------------------------------------------------------------
# Stages during testing.
#------------------------------------------------------------------------------

stages:
    - testing


#------------------------------------------------------------------------------
# Some variables to contol the testing behaviour.
#------------------------------------------------------------------------------

variables:
    # Clone repository by default.
    GIT_STRATEGY: clone
    # Flag that GitLab testing is active
    GITLAB_TESTING: 1

    # Path to ParaView
    PARAVIEW_PATH: "/imcs/public/compsim/opt/ParaView-5.10.1-osmesa-MPI-Linux-Python3.9-x86_64/"


#------------------------------------------------------------------------------
# Templates for the testing jobs.
#------------------------------------------------------------------------------

.pvutils-testing: &pvutils-testing
    stage: testing
    script:
        - "whoami"
        - "pwd"
        # Set system paths.
        - export PYTHONPATH="${PYTHONPATH}:${APPEND_TO_PYTHONPATH}"
        - export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        - echo PYTHONPATH=$PYTHONPATH
        - export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${APPEND_TO_LD_LIBRARY_PATH}"
        - echo LD_LIBRARY_PATH=$LD_LIBRARY_PATH
        # Run tests.
        - "cd tests"
        - "echo \"Testing with the following command\""
        - "echo ${GITLAB_TESTING_COMMAND}"
        - "${GITLAB_TESTING_COMMAND}testing_pvutils.py"
    tags:
        - "imcs-all"


#------------------------------------------------------------------------------
# Actual jobs for testing.
#------------------------------------------------------------------------------

5.10.1-pvpython:
    << : *pvutils-testing
    variables:
        GITLAB_TESTING_COMMAND: "${PARAVIEW_PATH}/bin/pvpython "

5.10.1-system-python:
    << : *pvutils-testing
    variables:
        GITLAB_TESTING_COMMAND: "/hdd/gitlab-runner/lib/spack/opt/spack/linux-ubuntu20.04-cascadelake/gcc-9.4.0/python-3.9.12-knt7uewenwz43ktwmtsn6zavs7u2i7qx/bin/python3 "
        APPEND_TO_PYTHONPATH: "${PARAVIEW_PATH}/lib/python3.9/site-packages"
        APPEND_TO_LD_LIBRARY_PATH: "${PARAVIEW_PATH}/lib"
